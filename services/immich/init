#!/usr/bin/env bash
parse_args() {
  SKIP_STEPS=()
  BACKUP_PATH=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --skip-steps|--skip-steps=*)
        if [[ "$1" == *=* ]]; then
          value="${1#*=}"
          shift
        else
          value="$2"
          shift 2
        fi
        split_csv "$value" SKIP_STEPS
      ;;
      
    --from-backup=*)
      # Form: --from-backup=/path
      BACKUP_PATH="${1#*=}"
      shift
      ;;
    --from-backup)
      # Form: --from-backup /path
      if [[ $# -ge 2 ]]; then
        BACKUP_PATH="$2"
        shift 2
      else
        echo "Error: --from-backup requires a path argument" >&2
        exit 1
      fi
      ;;

      *)
        echo "Unknown argument: $1"
        exit 1
      ;;
    esac
  done
}

main() {
  parse_args "$@"

  # Source non-skipped steps in name order, ensuring CWD is the service dir each time
  STEP_FILES=("$SERVICE_DIR"/init-steps/*.sh)
  IFS=$'\n' STEP_FILES=($(sort <<<"${STEP_FILES[*]}"))
  unset IFS
  for file in "${STEP_FILES[@]}"; do
    filename="$(basename "$file" .sh)"
    step_num="${filename%%-*}" # extract numeric prefix

    if skip_step "$step_num"; then
      echo "ðŸ¦˜ $filename"
      continue
    fi

    echo "ðŸªœ  $filename"
    cd "$SERVICE_DIR"
    source "$file"
  done

  print_success "Done!"
}

source "$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)/lib/cli.sh"