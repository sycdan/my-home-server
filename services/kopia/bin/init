#!/usr/bin/env bash
set -euo pipefail
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SERVICE_DIR="$(cd "$SCRIPT_DIR/../" && pwd)"
ROOT_DIR="$(cd "$SERVICE_DIR/../../" && pwd)"
LIB_DIR="$ROOT_DIR/lib"
source "$LIB_DIR/common.sh"
source "$LIB_DIR/services.sh"
source "$LIB_DIR/env.sh"
load_env "$ROOT_DIR"
load_env "$SERVICE_DIR"

SKIP_STEPS=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    --skip-steps)
      # split comma-separated list into array
      IFS=',' read -r -a parts <<< "$2"
      SKIP_STEPS+=("${parts[@]}")
      shift 2
      ;;
    *)
			# drop unrecognized args
      shift
      ;;
  esac
done

# Iterate over step files, skipping any in SKIP_STEPS
STEP_FILES=("$SCRIPT_DIR"/init-steps/*.sh)
IFS=$'\n' STEP_FILES=($(sort <<<"${STEP_FILES[*]}"))
unset IFS

for file in "${STEP_FILES[@]}"; do
  filename="$(basename "$file" .sh)"
  step_num="${filename%%-*}" # extract numeric prefix

  if skip_step "$step_num"; then
    echo "ðŸ¦˜ $filename"
    continue
  fi

  echo "ðŸªœ  $filename"
  source "$file"
done

print_success "Done!"